import 'import_me'
from 'me2' import 'string'
from 'me2' import 'enqueue_test'

define nows /\S+/
define quote /\"/
define word /[\w-]+/
define enqueue_test /enqueue test[\r\n]+/
define newline nl


grammar dict(default):
    skip ','
    match word ws '=' ws quote string quote:
        out.add_attribute('.', '$0', '$5')
    match '}':
        return

grammar list(default):
    skip ','
    match quote string quote:
        out.create('item', '$1')
    match '{':
        out.open('item')
        dict()
    match ']':
        do.return()

grammar section(default):
    match word ws '=' ws quote string quote nl:
        out.add('$0', '$5')
    match word ws '=' ws '[':
        out.open('$0')
        list()

grammar section(default):
    match word ws '=' ws quote string quote nl:
        out.add('$0', '$5')
    match word ws '=' ws '[':
        out.open('$0')
        list()

grammar input(default):
    imatch '[' /[A-Z]+/ ']' nl:
        out.enter('$1')
        section()
    match '[' word '.' word ']' nl:
        out.enter('$1/$3')
        section()
    when enqueue_test:
        out.enqueue_before(/(before) (this)/, '$0', '$1')
        out.enqueue_after(/(after) (that)/, '$0', '$1')
        out.enqueue_on_add(/(onadd)/, '$0')
        do.next()
    match enqueue_test:
        out.enter('enqueue?name="test"')
        enqueue_test()
        out.clear_queue()
    match 'add_attribute' ws word '=' word ' to ' word:
        out.add_attribute('$6', '$2', '$4')
    match 'replace text of' ws word ws word ws word:
        out.replace('$2', '$6')
    match 'remove_tag' ws word ' from ' word ' with attribute ' word '=' word:
        out.remove('$4?$6="$8"/$2')
    out.set_root_name('test')
    do.say('Done')
